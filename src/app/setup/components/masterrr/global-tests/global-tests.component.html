<!-- LABORATORY TESTS  -->
<div class="container-full py-2 px-3" style="min-height: 500px;">

    <!-- HEADING  -->
    <div class="row mb-3 g-3 justify-content-between" *ngIf="!showReport">
        <div class="col-lg-6 col-12">
            <!-- Laboratory Tests -->
            <div class="row border-5 border-start border-primary rounded-2 ps-2" *ngIf="!sourcing_lab">
                <div class="col-12">
                    <span class="fw-medium fs-5">Laboratory Tests</span>
                </div>
                <div class="col-12">
                    <span class="text-wrap td-color">Turn on/off essential features required for Laboratory Tests</span>
                </div>
            </div>

        </div>
        <!-- ADD NEW BUTTON FOR ADDING TESTS  -->
        <div class="col-lg-6 col-12 d-flex justify-content-lg-end justify-content-start">
            <app-addnewbutton (onAddNewClick)="openXl(addTest)" buttonText="Add Test" *ngIf="!showReport"
                content="content"></app-addnewbutton>
            <app-addnewbutton (onAddNewClick)="openXl(report, '')" buttonText="Add Template"
                *ngIf="showReport && activeIdTab == 1" content="content"></app-addnewbutton>

            <app-addnewbutton (onAddNewClick)="openXl(defaultParameter, '')" buttonText="Add Parameter"
                *ngIf="showReport && activeIdTab == 2" content="content"></app-addnewbutton>

        </div>
    </div>

    <!-- search box  -->
    <div class="row g-2 mb-3 justify-content-between" *ngIf="!showReport">
        <div class="col-lg-8 col-12">
            <div class="row g-2">
                <div class="col-5">
                    <app-searchbox placeholder="Search Tests" [spellcheck]="false" [applyAutoFocus]="false"
                        (searchTermChange)="searchQuery($event)" [searchTerm]="query"></app-searchbox>
                </div>
                <div class="col-5">
                    <app-select [selectItems]="depts" selectBindLabel="name" placeHolder="Select Department"
                        (onSelectionChanged)="selectDepartment($event)" [selectValue]="selectDept"></app-select>
                </div>
                <div class="col-2 d-flex gap-2" *ngIf="!sourcing_lab">
                    <button class="btn btn-primary rounded-3 text-nowrap" *ngIf="!inProgress"
                     (click)="toggleBulkEdit()">Bulk Edit</button>
                    <button class="btn btn-success rounded-3 px-2 d-flex flex-row align-items-center gap-2 "
                     *ngIf="isBulkEditing" [disabled]="inProgress" (click)="bulkSave()">
                        <span>{{inProgress ? 'Saving' : 'Save'}}</span>
                        <span *ngIf="inProgress" class="spinner-border spinner-border-sm mr-1"></span></button>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-12 d-flex justify-content-lg-end justify-content-start align-items-center">
            <div class="row">
                <div class="col-4">
                    <span class="fw-light">Showing</span>
                </div>
            </div>
            <div class="col-4 px-1">
                <select class="form-select form-select-sm rounded-3 fw-medium fs-6 w-100 font-DMSans"
                    style="width: auto" name="pageSize" placeholder="Select" (change)="changePageNumber($event)">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option [value]="all_count">All</option>
                </select>
            </div>
            <div class="col-3">
                <span class="fw-light">Entries</span>
            </div>

        </div>

    </div>


    <!-- global test table  -->
    <div class="row mb-3" *ngIf="!showReport">
        <div class="col-12">
            <app-datatable>
                <ng-container class="tableheader">
                    <th>Name and Sourcing Lab</th>
                    <th>Code</th>
                    <th>Department</th>
                    <th [class.text-end]="!isBulkEditing">
                        <span *ngIf="!isBulkEditing">Price</span>
                        <div class="d-flex flex-column" *ngIf="isBulkEditing">
                            <div>Price</div>
                            <div>
                              <app-num-input [maintainLimit]="false" styleVal="max-width: 100px" (inputValueChange)="bulkPrice($event)"
                              classVal="form-control fw-light rounded-3 fs-5 fw-bold" [disableInput]="inProgress"></app-num-input>
                            </div>
                          </div>
                    </th>
                     
                    <th [class.text-end]="!isBulkEditing" *ngIf="sourcing_lab">Processing Fee</th>
                    <th class="text-center" *ngIf="!sourcing_lab && !isBulkEditing">Report</th>
                    <th class="text-center"  *ngIf="!isBulkEditing">Edit</th>
                    <th class="text-center">Active</th>
                </ng-container>
                <ng-container class="tablebody">
                    <tr *ngFor="let test of global_tests" class="td-color">
                        <td>
                            <div class="d-flex flex-column" *ngIf="!isBulkEditing">
                                <small class="text-black fw-medium fs-6" [class.fs-5]="sourcing_lab"  [class.py-1]="sourcing_lab">
                                    <ngb-highlight [result]="test.name" [term]="query"></ngb-highlight>
                                </small>

                                <div class="d-flex">
                                    <small *ngIf="test?.sourcing_lab && !sourcing_lab" >
                                        <small 
                                            class="bg-dark fw-light d-flex align-items-center text-white rounded-3 px-1">
                                            {{b_id && b_id?.sourcing_lab?.initiator == b_id ? '' : 'From '}}{{test?.sourcing_lab?.partner?.organization_name}}
                                        </small>
                                    </small>
                                </div>

                            </div>

                            <app-input *ngIf="isBulkEditing" [removeCloseIcon]="true" [removeLabel]="true" placeHolder="Enter Test Name"
                            (onValueChanged)="updateTestValue($event, test, 'name')"  [inputDisable]="inProgress"
                            [inputValue]="test.name" classVal="form-control rounded-3 text-black fw-medium {{test?.name == null || test?.name == '' ? 'border-danger bg-soft-danger' : ''}}"></app-input>

                        </td>
                        <td>
                            <small *ngIf="!isBulkEditing">
                                <small>
                                    <ngb-highlight [result]="test.short_code" [term]="query"></ngb-highlight>
                                </small>
                            </small>

                            <app-input *ngIf="isBulkEditing" styleVal="max-width: 100px" [removeCloseIcon]="true"  [inputDisable]="inProgress"
                            [removeLabel]="true" placeHolder="Enter Short Code" (onValueChanged)="updateTestValue($event, test, 'short_code')"
                            [inputValue]="test?.short_code || ''" classVal="form-control rounded-3 text-black fw-light"></app-input>

                        </td>
                        <td>
                            <small>
                                <small>
                                    <ngb-highlight [result]="test.department | uppercase" [term]="query"></ngb-highlight>
                                </small>
                            </small>
                        </td>
                        <td class="text-black fs-6 text-end">
                            <ng-container *ngIf="!isBulkEditing; else editPrice">
                                <span class="fw-medium">{{ test.price }}</span>
                            </ng-container>
                            <ng-template #editPrice>
                                <app-num-input [inputValue]="test?.price" styleVal="max-width: 110px" (inputValueChange)="updateTestValue($event, test, 'price')"  [disableInput]="inProgress"
                                classVal="form-control rounded-3 text-black fw-medium {{test?.price == null || test?.price == '' ? 'border-danger bg-soft-danger' : ''}}" [maintainLimit]="false"></app-num-input>
                            </ng-template>
                        </td>

                        <td class="text-black fs-6 text-end" *ngIf="sourcing_lab">
                            <ng-container >
                                <span class="fw-medium">{{ test.expense_for_outsourcing }}</span>
                            </ng-container>
                        </td>
                        <td class="text-center" *ngIf="!sourcing_lab && !isBulkEditing">
                            <div class="d-flex align-items-center justify-content-center">
                                <button class="btn bg-transparent border-0 p-1" ngbTooltip="Create/Edit templates" (click)="reportTemplatePage(test.id)">
                                    <i class="bi bi-file-earmark-pdf fs-4"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-center" *ngIf="!isBulkEditing">
                            <div class="d-flex align-items-center justify-content-center">
                                <button class="btn bg-transparent border-0 p-1" ngbTooltip="Edit Test Details" (click)="singleTest(test)">
                                    <i class="ri-edit-2-line fs-4"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-center">
                            <app-checkbox classVal="form-switch" [checkboxValue]="test.is_active" [showLabel]="false"
                                activeText="" inactiveText="" [inputDisabled]="inProgress"
                                (onCheckboxValueChanged)="doInactive(test, $event)"></app-checkbox>
                        </td>
                    </tr>
                </ng-container>

                <ng-container class="tablebody" *ngIf="!global_tests || global_tests.length === 0">
                    <tr>
                        <td colspan="8">
                            <div class="text-black fs-6 font-monsterract d-flex flex-row gap-3 py-5 align-items-center justify-content-center "
                                style="vertical-align: middle;min-height: 100px;">
                                <!-- No data found -->
                                <!-- <small class="inactive">NO DATA FOUND</small>
                                    <img src="/assets/images/empty-box.png" style="width:50px"> -->

                            </div>
                        </td>
                    </tr>
                </ng-container>
            </app-datatable>
        </div>
    </div>

    <div class="row g-3 justify-content-between align-items-center" *ngIf="!showReport">
        <div class="col-lg-6 col-12 font-DMSans">
            <span class="text-nowrap">Showing {{(page_number * page_size) - page_size + 1}} to {{(page_number *
                page_size) < all_count ? page_number * page_size : all_count}} of {{ all_count ? all_count : 0 }}
                    Entries</span>
        </div>

        <div class="col-lg-6 col-12">
            <div class="d-flex justify-content-end font-DMSans">
                <app-pagination [collectionSize]="all_count || 0" [page]="page_number" [pageSize]="page_size"
                    (pageChange)="onPageChange($event)">
                </app-pagination>
            </div>
        </div>
    </div>

    <div class="row" *ngIf="showReport">

        <div class="col-lg-6 col-12 cursor-pointer" (click)="showReport = false;resetReportPage()">
            <div class="row align-items-center">


                <div class="col-12">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <i class="bi bi-arrow-left fs-4"></i>
                        </div>
                        <div class="col-4 text-left d-flex align-items-center gap-2">
                            <span>Go Back</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-12 d-flex justify-content-end flex-row align-items-center gap-2">
            <div class="text-end fs-5 fw-semibold d-flex  rounded">
                {{reportTemplateName}}
            </div>

            <div class="d-flex flex-row gap-2 justify-content-end">
                <app-addnewbutton (onAddNewClick)="openXl(report, '')" buttonText="Add Template"
                    *ngIf="showReport && activeIdTab == 1" content="content"></app-addnewbutton>

                <app-addnewbutton (onAddNewClick)="openXl(defaultParameter, '')" buttonText="Add Parameter"
                    *ngIf="showReport && activeIdTab == 2" content="content"></app-addnewbutton>
            </div>
        </div>
    </div>

    <!-- report templates page  -->
    <div class="row g-2" *ngIf="showReport">
        <div class="col-12">
            <div class="container-full">
                <div class="row">
                    <div class="col-12">
                        <ul ngbNav #nav="ngbNav" class="nav-tabs-custom" [activeId]="activeIdTab">
                            <li ngbNavItem [ngbNavItem]="1" (click)="activeIdTab = 1">
                                <a ngbNavLink class="fs-5">Templates</a>
                                <ng-template ngbNavContent>
                                    <ng-container *ngTemplateOutlet="reportTemplatesTab"></ng-container>
                                </ng-template>
                            </li>
                            <li ngbNavItem [ngbNavItem]="2" (click)="activeIdTab = 2;getTestDefaultParamters()">
                                <a ngbNavLink>
                                    <div class="d-flex flex-row align-items-center gap-2">
                                        <span class="fs-5">Default Parameters</span>
                                    </div>

                                </a>
                                <ng-template ngbNavContent>
                                    <ng-container *ngTemplateOutlet="defaultParamtersTable"></ng-container>
                                </ng-template>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div [ngbNavOutlet]="nav" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- add lab test -->
<ng-template #addTest let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom ">
        <span class="modal-title fs-5" id="modal-basic-title">{{ updateBool ? modelTitle : "Add Laboratory Test"}}</span>
        <button type="button" class="btn-close" aria-label="Close" (click)="resetForm(); sourcing_lab ? modal.dismiss('Cross click') : ''"></button>
    </div>
    <form [formGroup]="baseForm">
        <div class="modal-body" style="background-color: #F8FAFC;">
            <div class="container px-3">

                <div class="row mb-1">
                    <div class="col-12 fs-5 fw-normal logoColor border-bottom pb-2">
                        Laboratory Test Details
                    </div>
                </div>

                <div class="row g-2 mb-3 px-3">
                    <!-- name input  -->
                    <div class="col-lg-8 col-12">
                        <div class="row">
                            <div class="col-12">Test Name <span class="text-danger">*</span></div>
                            <div class="col-12">
                                <!-- Name Input  -->
                                <app-input [removeLabel]="true" placeHolder="Enter full name"
                                    (onValueChanged)="formatString($event, 'name')" [formSubmitted]="testSubmitted"
                                    formControlName="name" [applyAutoFocus]="true" 
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <!-- department  -->
                    <div class="col-lg-4  col-12">
                        <div class="row">
                            <div class="col-12">Department <span class="text-danger">*</span></div>
                            <div class="col-12">
                                <app-select [selectItems]="departments" selectBindLabel="name"
                                    [formSubmitted]="testSubmitted" placeHolder="Select Department"
                                    formControlName="department"></app-select>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row g-2 mb-3 px-3">
                    <!-- display name input  -->
                    <div class="col-lg-8 col-12">
                        <div class="row">
                            <div class="col-12">Display Name </div>
                            <div class="col-12">
                                <!-- display Name Input  -->
                                <!-- (onValueChanged)="formatString($event, 'display_name')" -->
                                <app-input [removeLabel]="true" placeHolder="Enter display name"
                                    [formSubmitted]="testSubmitted"
                                    formControlName="display_name" 
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row g-2 mb-3 px-3">
                    <!-- Short code  -->
                    <div class="col-lg-4  col-12">
                        <div class="row">
                            <div class="col-12">Short Code </div>
                            <div class="col-12">
                                <app-input [removeLabel]="true" placeHolder="" 
                                    (onValueChanged)="formatString($event,'short_code')"
                                    [formSubmitted]="testSubmitted" formControlName="short_code"
                                    classVal="form-control fw-semibold rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <!-- Target TAt -->
                    <div class="col-lg-3 col-12">
                        <div class="row">
                            <div class="col-12">Target TAT</div>
                            <div class="col-12">

                                <!-- <app-datepicker [datePickerFormat]="'H:i'" dateMode="range"></app-datepicker> -->
                                <input type="time" value="13:20" class="form-control fw-light rounded-3"
                                    id="exampleInputtime" formControlName="target_tat">
                            </div>
                        </div>
                    </div>

                    <!-- Sample Volume -->
                    <div class="col-lg-5  col-12">
                        <div class="row">
                            <div class="col-12">Sample Volume</div>
                            <div class="col-12">
                                <app-input [removeLabel]="true" placeHolder="Enter Sample Volume"
                                    [formSubmitted]="testSubmitted" formControlName="sample_volume"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>


                </div>

                <div class="row mb-5 px-3">


                    <!-- sample Information -->
                    <div class="col-lg-6  col-12">
                        <div class="row">
                            <div class="col-12">Sample Type</div>
                            <div class="col-12">
                                <app-input [removeLabel]="true" placeHolder="Enter Sample Type" 
                                    (onValueChanged)="formatString($event)" [formSubmitted]="testSubmitted"
                                    formControlName="sample" classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>
                    <!-- clinical information         -->
                    <div class="col-lg-6 col-12">
                        <div class="row">
                            <div class="col-12">Clinical Information</div>
                            <div class="col-12">
                                <app-input [removeLabel]="true" placeHolder="Enter Clinical Information"
                                    (onValueChanged)="formatString($event)" [formSubmitted]="testSubmitted"
                                    formControlName="clinical_information" 
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                </div>


                <div class="row mb-1">
                    <div class="col-12 fs-5 fw-normal logoColor border-bottom pb-2">
                        Pricing
                    </div>
                </div>


                <div class="row g-2 mb-5 px-3">
                    <!-- Test Price  -->
                    <div class="col-lg-3 col-12">
                        <div class="row">
                            <div class="col-12">Price <span class="text-danger">*</span></div>
                            <div class="col-12">
                                <!-- Test price  Input  -->
                                <app-input [removeLabel]="true" [maxlength]="10" [applyAllowUnderScore]="true"
                                    [applyAllowLettersOnly]="false" [applyAllowNumbersOnly]="true"
                                    [inputType]="'number'" classVal="form-control fw-light rounded-3"
                                    placeHolder="₹" [applySpecialChars]="true" [formSubmitted]="testSubmitted"
                                    formControlName="price"></app-input>
                            </div>
                        </div>
                    </div>

                    <!-- expense cost for sourcing  -->
                    <div class="col-lg-3 col-12" *ngIf="sourcing_lab">
                        <div class="row">
                            <div class="col-12">Processing Fee<span class="text-danger">*</span></div>
                            <div class="col-12">
                                <!-- price  Input  -->
                                <app-input [removeLabel]="true" [maxlength]="10" 
                                    [applyAllowLettersOnly]="false" [applyAllowNumbersOnly]="true"
                                    [inputType]="'number'" classVal="form-control fw-light rounded-3"
                                    placeHolder="₹"  [formSubmitted]="testSubmitted"
                                    formControlName="expense_for_outsourcing"></app-input>
                            </div>
                        </div>
                    </div>

                    <!-- Total Cost -->
                    <div class="col-lg-3 col-12">
                        <div class="row">
                            <div class="col-12">Total Cost </div>
                            <div class="col-12">
                                <!-- Test price  Input  -->
                                <app-input [removeLabel]="true" [applyAllowNumbersOnly]="true"
                                    classVal="form-control fw-light rounded-3" placeHolder="₹"
                                    [formSubmitted]="testSubmitted" formControlName="total_cost"></app-input>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-12">
                        <div class="row">
                            <div class="col-12">Inventry Cost </div>
                            <div class="col-12">
                                <!-- Test price  Input  -->
                                <app-input [removeLabel]="true" [applyAllowNumbersOnly]="true"
                                    classVal="form-control fw-light rounded-3" placeHolder="₹" 
                                    [formSubmitted]="testSubmitted" formControlName="inventory_cost"></app-input>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-1">
                    <div class="col-12 fs-5 fw-normal logoColor border-bottom pb-2">
                        Permission Groups
                    </div>
                </div>

                <div class="row mb-3 px-3">
                    <!-- is active  -->
                    <div class="col-lg-2 col-12">
                        <div class="row">
                            <div class="col-12">Active</div>
                            <div class="col-12 py-2 d-flex align-items-center">
                                <app-checkbox classVal="form-switch" formControlName="is_active" [showLabel]="false" ></app-checkbox>
                            </div>
                        </div>
                    </div>


                    <!-- out sourcing  -->
                    <div class="col-lg-2 col-12">
                        <div class="row">
                            <div class="col-12">Outsourcing</div>
                            <div class="col-12 py-2 d-flex align-items-center">
                                <app-checkbox formControlName="is_outsourcing" classVal="form-check" 
                                    [showLabel]="false" *ngIf="!sourcing_lab;else showLabName"></app-checkbox>
                                <ng-template #showLabName>
                                    <span class="fw-medium bg-dark text-white px-2 rounded-3">{{sourcing_lab?.organization_name}}</span>
                                </ng-template>
                            </div>
                        </div>
                    </div>



                    <!-- is accredated  -->
                    <div class="col-lg-2 col-12">
                        <div class="row">
                            <div class="col-12">Accredited</div>
                            <div class="col-12 py-2 d-flex align-items-center">
                                <app-checkbox formControlName="is_accreditation" classVal="form-check"
                                    [showLabel]="false"></app-checkbox>
                            </div>
                        </div>
                    </div>

                    <!-- is authorized  -->
                    <div class="col-lg-4 col-12">
                        <div class="row">
                            <div class="col-12">Doctor Authorization Required</div>
                            <div class="col-12 py-2 d-flex align-items-center">
                                <app-checkbox formControlName="is_authorization" classVal="form-check"
                                    [showLabel]="false" ></app-checkbox>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal-footer py-1 px-3 bg-light-blue border-top">
            <button type="submit" class="btn btn-success rounded-3"
                (click)=" updateBool ? updateSingle() : saveApiCall(); submitted=false;">
                {{ updateBool ? "Update Test" : "Save Test"}}<span *ngIf="inProgress"
                    class="spinner-border spinner-border-sm mr-1"></span>
            </button>
        </div>
    </form>
</ng-template>

<!-- add lab report template -->
<ng-template #report let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom">
        <span class="modal-title" id="modal-basic-title">Add Report Template</span>

        <button type="button" class="btn-close" aria-label="Close"
            (click)="submitted=false;modal.dismiss('Cross click');this.submitted=false;"></button>
    </div>
    <form [formGroup]="reportTemplateForm" (ngSubmit)="saveReport()">
        <div class="modal-body">

            <div class="container-full">

                <div class="row g-2 mb-3">

                    <!-- report name name input  -->
                    <div class="col-12 mb-2">
                        <div class="row">
                            <div class="col-12">Report Name <span class="text-danger">*</span></div>
                            <div class="col-12">
                                <!-- Name Input  
                                    
                                (onValueChanged)="formatString($event, 'reportName')"-->

                                <app-input [removeLabel]="true" placeHolder="Enter Test Name" [inputLength]="75"
                                    [formSubmitted]="submitted" formControlName="reportName" [applyAutoFocus]="true"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <!-- report_type  -->
                    <div class="col-12 mb-2">
                        <div class="row">
                            <div class="col-12">Report Type<span class="text-danger">*</span></div>
                            <div class="col-12">
                                <app-select [selectItems]="reportTypes" selectBindLabel="name"
                                    [formSubmitted]="submitted" placeHolder="Select Report Type"
                                    formControlName="reportType"></app-select>
                            </div>
                        </div>
                    </div>

                    <!-- is default  -->
                    <div class="col-12 mb-2">
                        <div class="row">
                            <!-- <div class="col-12">Is Default</div> -->
                            <div class="col-12 py-2 d-flex align-items-center">
                                <app-checkbox formControlName="is_default" [formSubmitted]="submitted"
                                    classVal="form-check" [showLabel]="false" activeText="Is Default"
                                    inactiveText="Is Default"></app-checkbox>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <div class="modal-footer py-0 px-3 bg-light-blue border-top">
            <button type="submit" class="btn btn-success shadow rounded-3">
                Save Report<span *ngIf="inProgress" class="spinner-border spinner-border-sm mr-1"></span>
            </button>
        </div>
    </form>
</ng-template>

<!-- fixed template form  -->
<ng-template #fixedTemplate let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom d-flex justify-content-between">
        <span class="modal-title" id="modal-basic-title">{{ReportTitle}}</span>
        <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn-close" aria-label="Close"
                (click)="changesMade || remarkChanges ? openXl(warningModal, '') :modal.dismiss('Cross click');"></button>
        </div>

    </div>

    <div class="modal-body overflow-auto" style="background-color: #F8FAFC;">

        <div class="container-full" style="min-height: 350px">

            <form [formGroup]="fixedReportForm" (ngSubmit)="saveFixedReport()">
                <!-- parameter adding first row  -->
                <div class="row mb-2 g-lg-2 g-2" *ngIf="!paramEditmode ">

                    <div class="col-lg-3 col-12">
                        <!-- parameter name input  -->
                        <div class="row">
                            <div class="col-12">Parameter <span class="text-danger">*</span></div>
                            <div class="col-12">
                                <!--parameter  Name Input  -->
                                <app-input [removeLabel]="true" placeHolder="Enter Parameter Name"
                                    (onValueChanged)="formatString($event, 'parameter')" [formSubmitted]="submitted"
                                    formControlName="parameter" [applyAutoFocus]="true"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-2 col-12">
                        <!-- Value name input  -->
                        <div class="row">
                            <div class="col-12">Value </div>
                            <div class="col-12">
                                <!--parameter  Name Input  -->
                                <app-input [removeCloseIcon]="true" [removeLabel]="true" placeHolder="Enter Value"
                                    [formSubmitted]="submitted" formControlName="value" [applyAutoFocus]="false"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-1 col-12">
                        <!-- unitsname input  -->
                        <div class="row">
                            <div class="col-12">Units </div>
                            <div class="col-12">
                                <!--parameter  Name Input  -->
                                <app-input [removeLabel]="true" placeHolder="Enter units"
                                    [formSubmitted]="submitted" formControlName="units" [applyAutoFocus]="false"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>


                    <div class="col-lg-3 col-12">
                        <!-- REF name input  -->
                        <div class="row">
                            <div class="col-12 d-flex flex-row gap-3">
                                <span>Referral Range</span>
                            </div>
                            <div class="col-12">
                                <app-textarea-input [removeCloseIcon]="true" [removeLabel]="true"
                                placeHolder="Enter Referral Ranges" formControlName="referral_range"
                                [applyAutoFocus]="false" classVal="form-control fw-light rounded-3"></app-textarea-input>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-12">
                        <!-- REF name input  -->
                        <div class="row">
                            <div class="col-12 d-flex flex-row gap-3">
                                <span>Normal Range</span>
                                <button type="button" class="btn btn-sm btn-primary py-0 px-2 rounded-3"
                                    (click)="openModal(referralRanges, {size: 'lg'});newParamRef = true">
                                    {{normal_ranges.length == 0 ? 'Add Ranges' : 'Edit Ranges'}}
                                </button>
                            </div>
                            <div class="col-12">

                                <!-- <ng-container *ngIf="normal_ranges.length != 0">
                                    <ng-container *ngTemplateOutlet="datatableTemplate"></ng-container>
                                </ng-container> -->
                                <!-- *ngIf="normal_ranges.length == 0" -->
                                <ng-container >
                                    <app-textarea-input  (click)="openModal(referralRanges, {size: 'lg'});newParamRef = true" [removeCloseIcon]="true" [removeLabel]="true"
                                        placeHolder="Click to Add Ranges" formControlName="normal_ranges_display"
                                        [applyAutoFocus]="false" [inputDisable]="true"
                                        classVal="form-control fw-light rounded-3"></app-textarea-input>
                                </ng-container>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- parameter adding second row  -->
                <div class="row mb-3 g-lg-2 g-2" *ngIf="!paramEditmode">
                    <div class="col-lg-3 col-12">
                        <!-- group input  -->
                        <div class="row">
                            <div class="col-12">Group</div>
                            <div class="col-12">
                                <app-input [removeLabel]="true" placeHolder="Enter Group Name"
                                    [formSubmitted]="submitted" formControlName="group" [applyAutoFocus]="false"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-2 col-12">

                        <!-- method input  -->
                        <div class="row">
                            <div class="col-12">Method </div>
                            <div class="col-12">
                                <!--parameter  Name Input  -->
                                <app-input [removeLabel]="true" placeHolder="Enter Method Name"
                                    [formSubmitted]="submitted" formControlName="method" [applyAutoFocus]="false"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-2 col-12">
                        <div class="row">
                            <ng-container *ngIf="formula_ranges == ''">
                                <div class="col-12">Formula </div>
                                <div class="col-12">
                                    <button type="button"
                                        (click)="newFormula = true;openModal(paramFormula, {size: 'lg'}); "
                                        class="btn btn-primary rounded-3 w-100">
                                        Add Formula
                                    </button>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="formula_ranges != ''">
                                <div class="col-12 d-flex flex-row gap-3">
                                    <span>Formula</span>
                                    <button type="button" class="btn btn-sm btn-primary py-0 px-2 rounded-3"
                                        (click)="openModal(paramFormula, {size: 'lg'});">
                                        Edit Formula
                                    </button>
                                </div>
                                <div class="col-12">
                                    <app-input [removeCloseIcon]="true" [removeLabel]="true"
                                        [inputValue]="formula_ranges" [inputDisable]="true"></app-input>
                                </div>
                            </ng-container>

                        </div>
                    </div>

                    <div class="col-lg-2 col-12">

                        <!-- method input  -->
                        <div class="row">
                            <div class="col-12">Machine Code </div>
                            <div class="col-12">
                                <!--parameter  Name Input  -->
                                <app-input [removeLabel]="true" placeHolder="Enter Code"
                                    [formSubmitted]="submitted" formControlName="mcode" [applyAutoFocus]="false"
                                    classVal="form-control fw-light rounded-3"></app-input>
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-2 col-12 d-flex flex-column justify-content-end">

                        <app-checkbox activeText="Bold" inactiveText="Bold"
                        [showLabel]="false" classVal="form-check"
                        formControlName="is_value_bold"></app-checkbox>

                        <app-checkbox activeText="Hide Units/Range" inactiveText="Hide Units/Range"
                        [showLabel]="false" classVal="form-check"
                        formControlName="is_value_only"></app-checkbox>

                    </div>

                    <div class="col-lg-1 col-12 d-flex ">
                        <div class="row">
                            <div class="col-12" style="visibility: hidden;">Method </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success rounded-3">Save</button>
                            </div>
                        </div>

                    </div>
                </div>
            </form>

            <div class="row mb-3">
                <div class="col-12 rounded-3">

                    <table class="table table-striped table-bordered rounded-3 border bg-white" >
                        <thead class="tableheader rounded-3 text-muted">
                            <th *ngIf="tableParameters?.length > 1">
                                <span class="fw-light p-0" ngbTooltip="Set order of parameters by drag and drop"
                                    placement="right">
                                    <i class="ri-arrow-up-down-line"></i>
                                </span>
                            </th>
                            <th *ngIf="paramEditmode">Delete</th>
                            <th class="text-start">Edit</th>
                            <th>Group</th>
                            <th>Parameter & Method
                                <!-- {{tableParameters.length != 0 ? '(' + tableParameters.length + ')' : ''}} -->

                            </th>
                            <th>Value & Formula</th>
                            <th>Units</th>
                            <th *ngIf="paramEditmode">Method</th>
                            <th class="text-nowwrap">Referral Range</th>
                            <th class="text-wrap">Normal Ranges</th>
                            <th class="text-center text-nowrap" ngbTooltip="Machine code" placement="bottom">M. Code</th>
                            <!-- <th class="text-wrap">Formula</th> -->
                            <th class="text-center text-wrap" ngbTooltip="Hide Units/Range" placement="bottom">Hide</th>
                            
                            <th *ngIf="paramEditmode" class="text-center">Bold</th>
                        </thead>
                        
                        <tbody cdkDropList (cdkDropListDropped)="drop($event)" class="tablebody example-list"
                            style="max-height: 300px;" > 
                            <tr class="cursor-pointer py-2 example-box expandRow" cdkDrag
                                *ngFor="let report of tableParameters" (dblclick)="selectedParam = report; openModal(updateParamModal, { size: 'lg', centered: true } )">
                                
                                <td class="fs-4 cursor-move" style="cursor: move;" cdkDragHandle
                                    *ngIf="tableParameters?.length > 1">: :
                                </td>

                                <td *ngIf="paramEditmode">
                                    <button class="border-0 bg-transparent text-danger fs-4"
                                        (click)="deleteParams(deleteModal,report )">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </td>

                                <td >
                                    <button type="button" class="border-0 bg-transparent fs-4 p-0 d-flex justify-content-start"
                                    (click)="selectedParam = report; openModal(updateParamModal, { size: 'lg', centered: true } )"><i class="ri-edit-2-line p-0"></i></button>
                                </td>

                                <td>
                                    <ng-container *ngIf="report.editmode">
                                        <app-input [removeCloseIcon]="true" [removeLabel]="true" placeHolder=""
                                            [applyAutoFocus]="false"
                                            [inputValue]="report?.group ? report?.group : ''"
                                            (onValueChanged)="updateFixedReportParameterGroup($event, report)"></app-input>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <small><small class="text-muted">{{report?.group || ""}}</small></small>
                                    </ng-container>
                                </td> 

                                <td>
                                    
                                    <ng-container *ngIf="report.editmode">
                                        <app-input [removeCloseIcon]="true" [removeLabel]="true"
                                            placeHolder="Enter Parameter Name" [applyAutoFocus]="false"
                                            [inputValue]="report.parameter"
                                            (onValueChanged)="updateFixedReportParameterName($event, report)"></app-input>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <div class="d-flex flex-column">
                                            <small class="fw-semibold">{{report?.parameter || ""}}</small>
                                            <span class="text-muted">
                                                <small><small><i>{{report?.method || ""}}</i></small></small>
                                            </span>
                                        </div>
                                    </ng-container>
                                </td>

                                <td>
                                    <ng-container *ngIf="report.editmode">
                                        <div style="min-width: 100px ;max-width: 100px">
                                            <app-input [removeCloseIcon]="true" [removeLabel]="true"
                                                placeHolder="" [applyAutoFocus]="false"
                                                [inputValue]="report.value ? report.value : ''"
                                                (onValueChanged)="updateFixedReportParameterValue($event, report)"
                                                [classVal]="'form-control rounded-3 ' + (report?.is_value_bold ? 'fw-bold' : 'fw-light')"></app-input>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <div class="d-flex flex-column">
                                            <div>
                                                <small [class.fw-bold]="report.is_value_bold"> {{report?.value || ""}}</small>
                                            </div>
                                            <div class="td-color">
                                                <small><small [innerHTML]="withoutSpecChars(report?.formula)"></small></small>
                                            </div>
                                        </div>
                                    </ng-container>
                                </td>

                                <td>
                                    <ng-container *ngIf="report.editmode">
                                        <div style="max-width: 100px">
                                            <app-input [removeCloseIcon]="true" [removeLabel]="true"
                                                placeHolder="" [applyAutoFocus]="false"
                                                [inputValue]="report.units ? report.units : ''"
                                                (onValueChanged)="updateFixedReportParameterUnits($event, report)"></app-input>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <small>{{report?.units || ""}}</small>
                                    </ng-container>
                                </td>

                                <td *ngIf="report.editmode">
                                    <ng-container *ngIf="report.editmode">
                                        <div style="max-width: 100px;">
                                            <app-input [removeCloseIcon]="true" [removeLabel]="true"
                                                placeHolder="" [applyAutoFocus]="false"
                                                [inputValue]="report?.method ? report?.method : ''"
                                                (onValueChanged)="updateFixedReportParameterMethod($event, report)"></app-input>
                                        </div>
                                    </ng-container>
                                </td>

                                <td>
                                    <ng-container *ngIf="report.editmode">
                                        <div class="d-flex flex-column">
                                            <div>
                                                <textarea class="fw-medium form-control rounded-3 border"
                                                    [spellcheck]="false"
                                                    [value]="report.referral_range ? report.referral_range : ''"
                                                    style="height: 64px; min-width: 220px;"
                                                    [disabled]="report?.normal_ranges && report?.normal_ranges.length != 0"
                                                    (input)="updateFixedReportParameterReferral($event, report)"></textarea>
                                            </div>
                                            <div>
                                                <button type="button"
                                                    class="btn btn-sm btn-primary py-0 px-2 rounded-3"
                                                    (click)="openModal(referralRanges, {size: 'lg'}); setNR(report)">
                                                    {{report.normal_ranges && report?.normal_ranges.length != 0 ? 'Edit Ranges' : 'Add Ranges'}}
                                                </button>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <small><small [innerHTML]="withoutSpecChars(report?.referral_range)"></small></small>
                                    </ng-container>
                                </td>


                                <!-- normal ranges , normal ranges display  -->
                                <td>
                                    <ng-container *ngIf="report.editmode">
                                        <div class="d-flex flex-column">
                                            <div>
                                                <textarea class="fw-medium form-control rounded-3 border"
                                                    [spellcheck]="false"
                                                    [value]="report.normal_ranges_display ? report.normal_ranges_display : ''"
                                                    style="height: 64px; min-width: 220px;"
                                                    [disabled]="true" ></textarea>
                                            </div>
                                            <div>
                                                <button type="button"
                                                    class="btn btn-sm btn-primary py-0 px-2 rounded-3"
                                                    (click)="openModal(referralRanges, {size: 'lg'}); setNR(report)">
                                                    {{report.normal_ranges && report?.normal_ranges.length != 0 ? 'Edit Ranges' : 'Add Ranges'}}
                                                </button>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <small><small [innerHTML]="withoutSpecChars(report?.normal_ranges_display)"></small></small>
                                    </ng-container>
                                </td>

                                <td *ngIf="false">
                                    <ng-container *ngIf="report.editmode">
                                        <div class="d-flex flex-column">
                                            <div *ngIf="report?.formula != ''">
                                                <app-textarea-input
                                                    classVal="fw-medium form-control rounded-3 border"
                                                    [spellcheck]="false" [removeCloseIcon]="true"
                                                    [removeLabel]="true"
                                                    [inputValue]="report?.formula ? report?.formula : ''"
                                                    style="height: 64px"
                                                    [inputDisable]="true"></app-textarea-input>
                                            </div>
                                            <div>
                                                <button type="button"
                                                    class="btn btn-sm btn-primary py-0 px-2 rounded-3"
                                                    (click)="setFormula(report); openModal(paramFormula, {size: 'lg'});  ">
                                                    {{report?.formula && report?.formula !='' ? 'Edit Formula' :
                                                    'Add Formula'}}
                                                </button>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="!report.editmode">
                                        <div [innerHTML]="withoutSpecChars(report?.formula)"></div>
                                    </ng-container>
                                </td>

                                <td>
                                    <div class="d-flex flex-column">
                                        <small><small>{{report?.mcode || ""}}</small></small>
                                        <small *ngIf="report?.round_to_decimals"><small>{{report?.round_to_decimals || ""}} dcmls rounded</small></small>
                                    </div>
                                </td>

                                <td class="text-center">
                                    <small class="d-flex flex-column justify-content-center">
                                        <app-checkbox activeText="U/R" inactiveText="U/R"
                                            
                                            (onCheckboxValueChanged)="updateFixedReportParameterValueOnly($event, report, 'is_value_only')"
                                            [showLabel]="false" classVal="form-check" labelClass="form-check-label ps-1"
                                            [checkboxValue]="report.is_value_only"></app-checkbox>

                                            <!-- [inputDisabled]="!report.editmode" -->
                                            <app-checkbox activeText="In Print" inactiveText="In Print"
                                            (onCheckboxValueChanged)="updateFixedReportParameterValueOnly($event, report, 'to_display')"
                                            [showLabel]="false" classVal="form-check" labelClass="form-check-label ps-1"
                                            [checkboxValue]="!report?.to_display"></app-checkbox>
                                            
                                    </small>
                                </td>

                                <td class="text-center" *ngIf="paramEditmode">
                                    <div class="d-flex justify-content-center">
                                        <app-checkbox activeText="" inactiveText=""
                                            [inputDisabled]="!report.editmode"
                                            (onCheckboxValueChanged)="updateFixedReportParameterBold($event, report)"
                                            [showLabel]="false" classVal="form-check"
                                            [checkboxValue]="report?.is_value_bold"></app-checkbox>
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td colspan="8" *ngIf="tableParameters?.length == 0">
                                    <div class="py-3 text-center fw-light text-muted">
                                        No Parameters Recorded
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-2 fw-semibold">
                    Default Remarks
                </div>
                <div class="col-12">
                    <app-mini-editor [html]="ReportId?.default_technician_remarks || ''"
                        (extractedContentChange)="updateReportRemark($event)"></app-mini-editor>
                </div>
            </div>
        </div>

    </div>

    <div class="modal-footer py-0 px-3 bg-light-blue border-top d-flex justify-content-end">
        <button class="btn shadow btn-success rounded-3 px-3 py-2" (click)="closeReportModels()"
            *ngIf="(changesMade || remarkChanges) && !inProgress">
            Save & Close<span *ngIf="inProgress" class="spinner-border spinner-border-sm mr-1"></span>
        </button>
    </div>

</ng-template>

<!-- word template form  -->
<ng-template #wordReport let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue d-flex justify-content-between align-items-center">
        <span class="modal-title" id="modal-basic-title">{{ ReportTitle }}</span>
        <div>
            <button type="button" class="btn-close" aria-label="Close"
                (click)="submitted=false; changesMade ? openXl(warningModal, '') : modal.dismiss('Cross click')"></button>
        </div>
    </div>

    <div class="modal-body p-0">
        <div class="container-full p-0">
            <div class="row p-0 g-0 " [style]="!fullScreen ? 'max-height: 82vh;min-height: 82vh;' : ''">
                <div class="col-12">
                    <app-dev-rich [rtf_content]="wordReportTemplate?.rtf_content" [content]="wordReportTemplate.report" (extractedContentChange)="handleExtractedContentChange($event)"></app-dev-rich>
                </div>
            </div>
        </div>
        <div contenteditable="false" id="previewofreport" class="previewofreport">
            <iframe allowfullscreen id="preview_iframe_setup"
                [style]="'height: 100%; width: ' + (fullScreen ? '109' : '69') + 'mm;'"></iframe>
        </div>

    </div>
</ng-template>

<!-- close modal  -->
<ng-template #warningModal let-modal>
    <div class="modal-body">
        <div class="container-full">
            <div class="row">
                <div class="col-12 fs-5">
                    Are you sure you want to exit without saving ?
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer py-1 px-3  d-flex justify-content-end">
        <button class="btn btn-danger rounded-3" (click)="modal.dismiss('Cross click');">
            No, Stay
        </button>

        <!-- closeReportModels(false) -->
        <button class="btn btn-success rounded-3" (click)="changesMade=false;modalService.dismissAll();">
            Yes, Exit
        </button>
    </div>
</ng-template>

<!-- delete modal  -->
<ng-template #deleteModal let-modal>
    <div class="modal-body">
        <div class="container-full">
            <div class="row mb-3">
                <div class="col-12 fs-5">
                    Are you sure you want to Delete Parameter ?
                </div>
            </div>
        </div>

        <div class="row border rounded-3 shadow bg-light-blue">
            <div class="col-12">
                <table class="table">
                    <tbody>
                        <tr>
                            <td>
                                Parameter
                            </td>
                            <td class="text-center">
                                Value
                            </td>
                            <td class="text-center">
                                Units
                            </td>
                            <td class="text-center">
                                Referral Range
                            </td>
                        </tr>
                        <tr class="bg-white font-Readex" *ngFor="let item of deleteParam">

                            <td class="fs-5 fw-medium">
                                <div class="d-flex flex-column ">
                                    <span class="fs-5 fw-medium">
                                        {{item.parameter}}
                                    </span>
                                    <small class="font-italic td-color">
                                        <i>{{item?.method ? item?.method : ''}}</i>
                                    </small>
                                </div>
                            </td>

                            <!-- <td class="text-center">{{item.value}}</td> -->

                            <td colspan="1" class="py-2 text-center">
                                <span [class.fw-bold]="item.is_value_bold">{{item.value}}</span>
                            </td>
                            <td class="fs-6 text-center">{{item.units}}</td>
                            <td class="text-center">
                                <div [innerHTML]="withoutSpecChars(item.referral_range)"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-footer py-1 px-3  d-flex justify-content-end">
        <button class="btn btn-danger rounded-3" (click)="modal.dismiss('Cross click');">
            No, Go Back
        </button>

        <button class="btn btn-success rounded-3" (click)="modal.dismiss('Cross click');deleteParamter()">
            Yes, Delete
        </button>
    </div>
</ng-template>

<!-- default parameter  -->
<ng-template #defaultParameter let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom">
        <span class="modal-title" id="modal-basic-title">{{updateParameter ? 'Update default Parameter' : 'Add Default Parameter '}} | {{reportTemplateName}}</span>

        <button type="button" class="btn-close" aria-label="Close"
            (click)="modal.dismiss('Cross click'); this.defaultParameterString = ''; updateParameter = null"></button>
    </div>
    <div class="modal-body">
        <div class="container-full">
            <div class="row g-1 mb-2">
                <div class="col-12">
                    Parameter <span class="text-danger">*</span>
                </div>
                <div class="col-12">
                    <!-- <app-input [removeCloseIcon]="true" [removeLabel]="true"></app-input> -->
                    <textarea class="form-control" placeholder="Type Parameter .." autofocus
                        style="min-height: 100px" [spellcheck]="false"
                        [(ngModel)]="defaultParameterString"></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-12 d-flex justify-content-end">
                    <button class="btn btn-success fs-5 rounded-3"
                        (click)="updateParameter ? updateParam() : SaveParameter()">Save</button>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #defaultParamtersTable>
    <div class="row" *ngIf="showReport">
        <app-datatable>
            <ng-container class="tableheader">
                <th>Parameter</th>
                <th class="text-center">Is Active</th>
            </ng-container>
            <ng-container class="tablebody">
                <tr *ngFor="let template of parameters">
                    <td (click)="setParam(template);openXl(defaultParameter, '')" class="text-wrap">
                        {{template.parameter}}</td>
                    <td class="text-center">
                        <app-checkbox classVal="form-switch" [checkboxValue]="template?.is_active"
                            [showLabel]="false" (onCheckboxValueChanged)="changeIsActive(template)" activeText=""
                            inactiveText=""></app-checkbox>
                    </td>
                </tr>
            </ng-container>

            <ng-container class="tablebody" *ngIf="parameters?.length === 0">
                <tr>
                    <td colspan="8">
                        <div class="td-color fs-6 py-5 font-monsterract fw-medium d-flex flex-column align-items-center justify-content-center"
                            style="vertical-align: middle;min-height: 100px;">
                            <!-- NO depts -->
                            <img src="/assets/images/file.png" style="width:17%">
                            <small class="td-color pt-2">NO DATA</small>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </app-datatable>
    </div>
</ng-template>

<ng-template #reportTemplatesTab>
    <div class="row" *ngIf="showReport">
        <app-datatable>
            <ng-container class="tableheader">
                <th>Report</th>
                <th class="text-center">Type</th>
                <th class="text-center">Default</th>
                <td class="text-center fw-semibold">Edit</td>
                <!-- <td></td> -->
                <!-- <th class="text-center">Report</th> -->
                <!-- <td class="text-center">Active</td> -->
            </ng-container>
            <ng-container class="tablebody">
                <tr *ngFor="let template of filterTemplates" (mouseenter)="displayEdit(template, true)"
                    (mouseleave)="displayEdit(template, false)">
                    <td>
                        <span
                            class="cursor-pointer border-0 bg-transparent text-nowrap d-flex align-items-center gap-2 py-1 text-black">
                            <span
                                *ngIf="!template.editMode || template.id !== activeTmplt.id">{{template.name}}</span>
                            <input *ngIf="template.editMode && template.id === activeTmplt.id"
                                [class]="template.editMode ? 'text-black form-control border bg-white' : 'hidden'"
                                type="text" [(ngModel)]="template.name"
                                (input)="changeReportName($event, template)">
                            <button *ngIf="!template.editMode || template.id !== activeTmplt.id"
                                class="btn edit-btn btn-sm border-0 bg-transparent fs-5 ps-2 td-color"
                                (click)="toggleEditMode(template)">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button *ngIf="template.editMode && template.id === activeTmplt.id"
                                class="btn btn-sm border-0 bg-transparent fs-4 p-0 text-danger"
                                (click)="reportTemplatePage(selectedLabGlobalTest)">
                                <i class="ri-close-line"></i>
                            </button>
                            <button *ngIf="template.editMode && template.id === activeTmplt.id"
                                class="btn btn-sm border-0 bg-transparent fs-4 p-0 text-success"
                                (click)="saveReportName()">
                                <i class="ri-check-line"></i>
                            </button>
                        </span>
                    </td>

                    <!-- <td class="fw-medium fs-5">{{getTestName(template.LabGlobalTestID)?.name}}</td> -->
                    <td class="td-color text-center">{{getReportName(template.report_type)?.name}}</td>
                    <td class="text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <app-checkbox classVal="form-check" [checkboxValue]="template.is_default"
                                [showLabel]="false" activeText="" inactiveText=""
                                (onCheckboxValueChanged)="updateDefault(template, $event)"></app-checkbox>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="d-flex align-items-center justify-content-center"
                            (click)="openReport(fixedTemplate, template)">
                            <button class="btn bg-transparent border-0 p-1">
                                <i class="ri-edit-2-line fs-4"></i>
                            </button>
                        </div>
                    </td>

                </tr>
            </ng-container>

            <ng-container class="tablebody" *ngIf="filterTemplates?.length === 0">
                <tr>
                    <td colspan="8">
                        <div class="td-color fs-6 py-5 font-monsterract fw-medium d-flex flex-column align-items-center justify-content-center"
                            style="vertical-align: middle;min-height: 100px;">
                            <!-- NO depts -->
                            <img src="/assets/images/file.png" style="width:17%">
                            <small class="td-color pt-2">NO DATA</small>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </app-datatable>
    </div>
</ng-template>

<ng-template #referralRanges let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom">
        <span class="modal-title" id="modal-basic-title">Normal Range</span>

        <button type="button" class="btn-close" aria-label="Close"
            (click)="modal.dismiss('Cross click');checkNAddReferralRange()"></button>
    </div>
    <div class="modal-body">

        <form [formGroup]="referralRangeForm" (ngSubmit)="newParamRef? saveReferralRange() : checkValidNormalRange()">
            <div class="row mb-3">
                <div class="col-2">
                    <div class="row">
                        <div class="col-12">
                            Gender
                        </div>
                        <div class="col-12">
                            <app-select labelText="" selectBindLabel="name" formControlName="gender"
                                [selectItems]="refGenders || []" placeHolder="Select Gender"></app-select>
                        </div>
                    </div>
                </div>

                <div class="col-3">
                    <div class="row">
                        <div class="col-12">
                            Min. Age
                        </div>
                        <div class="col-12">
                            <div class="row g-0">
                                <div class="col-6">
                                    <app-input [applyAllowNumbersOnly]="true"
                                        classVal="form-control rounded-0 rounded-start" [removeLabel]="true"
                                        [removeCloseIcon]="true" [inputLength]="3" placeHolder="Enter Age"
                                        formControlName="age_min"></app-input>
                                </div>
                                <div class="col-6">
                                    <select class="form-select rounded-0 rounded-end bg-soft-primary"
                                        formControlName="age_min_units" aria-label="Text input with select button">
                                        <option disabled>Select</option>
                                        <ng-container *ngFor="let item of refAges">
                                            <option [value]="item.id">{{item.name}}</option>
                                        </ng-container>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-3">
                    <div class="row">
                        <div class="col-12">
                            Max. Age
                        </div>
                        <div class="col-12">
                            <div class="row g-0">
                                <div class="col-6">
                                    <app-input [applyAllowNumbersOnly]="true"
                                        classVal="form-control rounded-0 rounded-start" [removeLabel]="true"
                                        [removeCloseIcon]="true" [inputLength]="3" placeHolder="Enter Age"
                                        formControlName="age_max"></app-input>
                                </div>
                                <div class="col-6">
                                    <select class="form-select rounded-0 rounded-end bg-soft-primary"
                                        formControlName="age_max_units" aria-label="Text input with select button">
                                        <option disabled>Select</option>
                                        <ng-container *ngFor="let item of refAges">
                                            <option [value]="item.id">{{item.name}}</option>
                                        </ng-container>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <div class="row mb-3">

                <div class="col-3">
                    <div class="row">
                        <div class="col-12">
                            Min. Range
                        </div>
                        <div class="col-12">
                            <app-input [applyAllowNumbersOnly]="true" [removeLabel]="true" [removeCloseIcon]="true"
                                classVal="form-control rounded-2 fw-normal" placeHolder="Enter Value"
                                formControlName="value_min"></app-input>
                        </div>
                    </div>
                </div>

                <div class="col-3">
                    <div class="row">
                        <div class="col-12">
                            Max. Range
                        </div>
                        <div class="col-12">
                            <app-input [applyAllowNumbersOnly]="true" [removeLabel]="true" [removeCloseIcon]="true"
                                classVal="form-control rounded-2 fw-normal" placeHolder="Enter Value"
                                formControlName="value_max"></app-input>
                        </div>
                    </div>
                </div>

                <div class="col-2">
                    <div class="row">
                        <div class="col-12">
                            <span class="visibility-none">*</span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success rounded-3"
                        (click)="newParamRef? saveReferralRange() : checkValidNormalRange()">Save</button>
                </div>
            </div>
        </form>

        <div class="row">
            <div class="col-12">
                <app-datatable>
                    <ng-container class="tableheader">
                        <th>Gender</th>
                        <th>Age From</th>
                        <th>Age UpTo</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Delete</th>
                    </ng-container>
                    <ng-container class="tablebody" *ngFor="let item of normal_ranges; let i = index">
                        <tr>
                            <td>{{returnNRGenderName(item.gender)}}</td>
                            <td>{{item.age_min}} {{returnNRAges(item.age_min_units)}}</td>
                            <td>{{item.age_max}} {{returnNRAges(item.age_max_units)}}</td>
                            <td>{{item.value_min}}</td>
                            <td>{{item.value_max}}</td>
                            <td>
                                <button class="border-0 bg-transparent text-danger fs-4"
                                    (click)="deleteNewNR(i) ; newParamRef? null : deleteNormalRange(item)">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </td>
                        </tr>
                    </ng-container>
                </app-datatable>
            </div>
        </div>



    </div>
</ng-template>

<ng-template #datatableTemplate>
    <app-datatable [height]="0">
        <ng-container class="tableheader">
            <th class="py-0"><small>Gender</small></th>
            <th class="py-0"><small>Age</small></th>
            <th class="py-0"><small>Value</small></th>
            <th class="py-0"><small>Delete</small></th>
        </ng-container>
        <ng-container class="tablebody" *ngFor="let item of normal_ranges; let i = index">
            <tr>
                <td>
                    <small>{{ returnNRGenderName(item.gender) }}</small>
                </td>
                <td>
                    <small>{{ item.age_min }} {{ returnNRAges(item.age_min_units) }} to {{ item.age_max }} {{
                        returnNRAges(item.age_max_units) }}</small>
                </td>
                <td>
                    <small class="fw-medium">{{ item.value_min }} - {{ item.value_max }}</small>
                </td>
                <td>
                    <button class="border-0 bg-transparent text-danger fs-5 p-0" (click)="deleteNewNR(i)">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </td>
            </tr>
        </ng-container>
    </app-datatable>
</ng-template>

<ng-template #paramFormula let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue border-bottom fs-5">
        <span class="modal-title" id="modal-basic-title">Formula</span>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click');"></button>
    </div>
    <div class="modal-body">
        <div class="container-full">
            <div class="row g-1 mb-2">
                <div class="col-12">
                    <ng-container *ngFor="let param of tableParameters">
                        <ng-container
                            *ngIf="(!newFormula && selectedParam.parameter != param.parameter) || newFormula">
                            <button class="btn btn-sm me-2 rounded-pill mb-1 border bg-light-blue" ngbTooltip="Add `{{param.parameter}}`"
                                (click)="addFormula(param.parameter)">{{param.parameter}}</button>
                        </ng-container>
                    </ng-container>
                    <button class="btn btn-sm me-2 rounded-pill mb-1 border bg-light-blue" ngbTooltip="Add `Patient Age In Days`"
                    (click)="addFormula('PatientAgeInDays')">Patient Age In Days</button>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <app-textarea-input [rows]="3" classVal="form-control fs-5 rounded-3"
                        [labelText]="newFormula ? 'Formula' : 'Formula For ' + selectedParam?.parameter"
                        [placeHolder]="'Enter Formula'" [inputId]="'formula_input'" [removeCloseIcon]="true"
                        [inputValue]="newFormula ? formula_ranges : selectedParam.formula"
                        (onValueChanged)="changeFormula($event)"></app-textarea-input>
                </div>
            </div>

            <div class="row">
                <div class="col-12 d-flex justify-content-end fs-5 px-2">
                    <button (click)="modal.dismiss('Cross click');" class="btn btn-success fs-5">Save</button>
                </div>
            </div>
        </div>
    </div>

</ng-template>

<ng-template let-modal #updateParamModal>
    <div class="modal-header py-2 px-3 fs-5 modal-bg">
        <span class="modal-title" id="modal-basic-title">Edit Parameter Details</span>
    </div>
    <div class="modal-body p-3 rounded-3" style="background-color: #F8FAFC;">
        <div class="container-full">
            <div class="row mb-3 g-3">
                <div class="col-lg-8 col-12">
                    <app-input [removeCloseIcon]="true" labelText="Parameter" [imp]="true" classVal="form-control fs-5 rounded-3"
                        placeHolder="Enter Parameter Name" [applyAutoFocus]="false" labelClass="form-label mb-1" 
                        [inputValue]="selectedParam?.parameter" (onValueChanged)="updateFixedParameter($event, selectedParam, 'parameter')"></app-input>
                </div>

                <div class="col-lg-4 col-12">
                    <app-input [removeCloseIcon]="true" 
                    placeHolder="" [applyAutoFocus]="false" labelText="Value"  labelClass="form-label mb-1"
                    [inputValue]="selectedParam.value ? selectedParam.value : ''" 
                    (onValueChanged)="updateFixedParameter($event, selectedParam, 'value')"
                    [classVal]="'form-control rounded-3 fs-5 ' + (selectedParam?.is_value_bold ? 'fw-bold' : '')"></app-input>
                </div>
            </div>

            <div class="row mb-3 g-3">
                <div class="col-lg-4 col-12">
                    <app-checkbox activeText="Hide Parameter in Report Print" inactiveText="Hide Parameter in Report Print"
                    (onCheckboxValueChanged)="updateFixedParameter($event, selectedParam, 'to_display')"
                    [showLabel]="false" classVal="form-check fs-5"  labelClass="form-check fs-5 ps-1 text-nowrap"
                    [checkboxValue]="!selectedParam?.to_display"></app-checkbox>
                </div>

                <div class="col-lg-4 col-12">
                    <app-checkbox activeText="Hide Units/Referral Ranges" inactiveText="Hide Units/Referral Ranges"
                    (onCheckboxValueChanged)="updateFixedParameter($event, selectedParam, 'is_value_only')"
                    [showLabel]="false" classVal="form-check fs-5"  labelClass="form-check fs-5 ps-1 text-nowrap"
                    [checkboxValue]="selectedParam?.is_value_only"></app-checkbox>
                </div>

                <div class="col-lg-3 col-12">
                    <app-checkbox activeText="Highlight Value" inactiveText="Highlight Value"
                    (onCheckboxValueChanged)="updateFixedParameter($event, selectedParam, 'is_value_bold')"
                    [showLabel]="false" classVal="form-check fs-5"  labelClass="form-check fs-5 ps-1 text-nowrap"
                    [checkboxValue]="selectedParam?.is_value_bold"></app-checkbox>
                </div>

            </div>

            <div class="row mb-3 g-3">
                <div class="{{selectedParam?.mcode ? 'col-lg-2' : 'col-lg-3'}} col-12">
                    <app-input [removeCloseIcon]="true" labelText="Units"  labelClass="form-label mb-1"  classVal="form-control fs-5 rounded-3"
                        placeHolder="" [applyAutoFocus]="false" [inputValue]="selectedParam?.units ? selectedParam?.units : ''"
                        (onValueChanged)="updateFixedParameter($event, selectedParam, 'units')"></app-input>
                </div>

                <div class="col-lg-3 col-12">
                    <app-input [removeCloseIcon]="true" labelText="Machine Code"  labelClass="form-label mb-1"  classVal="form-control fs-5 rounded-3"
                        placeHolder="" [applyAutoFocus]="false" [inputValue]="selectedParam?.mcode ? selectedParam?.mcode : ''"
                        (onValueChanged)="updateFixedParameter($event, selectedParam, 'mcode')"></app-input>
                </div>

                <div class="col-lg-2 col-12" *ngIf="selectedParam?.mcode">
                    <app-num-input [removeLabel]="false" labelText="Round M.Value"  labelClass="form-label mb-1"  classVal="form-control fs-5 rounded-3"
                        placeHolder="" [inputValue]="selectedParam?.round_to_decimals" [limit]="5"
                        (inputValueChange)="updateFixedParameter($event, selectedParam, 'round_to_decimals')"></app-num-input>
                </div>

                <div class="col-lg-5 col-12">
                    <app-input [removeCloseIcon]="true" labelClass="form-label mb-1"
                    placeHolder="" [applyAutoFocus]="false" labelText="Method"  classVal="form-control fs-5 rounded-3"
                    [inputValue]="selectedParam?.method ? selectedParam?.method : ''"
                    (onValueChanged)="updateFixedParameter($event, selectedParam, 'method')"></app-input>
                </div>
            </div>

            <div class="row mb-3 g-3">
                <div class="col-lg-6 col-12" (click)="getGroupsName()">
                    <!-- [useTypeahead]="true" [typeAheadArray]="groups" -->
                    <app-input [removeCloseIcon]="true" placeHolder=""  classVal="form-control fs-5 rounded-3"
                    [applyAutoFocus]="false" labelText="Group" labelClass="form-label mb-1"
                    [inputValue]="selectedParam?.group ? selectedParam?.group : ''"
                    (onValueChanged)="updateFixedParameter($event, selectedParam, 'group')"></app-input>
                </div>

                <div class="col-lg-6 col-12">
                    <div class="row">
                        <ng-container>
                            <div class="col-12 d-flex flex-row gap-3 mb-1">
                                <span>Formula</span>
                                <button type="button" class="btn btn-sm btn-primary py-0 px-2 rounded-3" *ngIf="false"
                                    (click)="newFormula=false; openModal(paramFormula, {size: 'lg'});">
                                    Edit Formula
                                </button>
                            </div>
                            <div class="col-12">
                                <app-input [removeCloseIcon]="true" [removeLabel]="true" (click)="newFormula=false;openModal(paramFormula, {size: 'lg'});" 
                                    (onValueChanged)="newFormula=false; openModal(paramFormula, {size: 'lg'});"  classVal="form-control fs-5 rounded-3"
                                    [inputValue]="newFormula ? formula_ranges : selectedParam?.formula" placeHolder=""></app-input>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>


            <div class="row mb-3">

                <!-- referral ranges  -->
                <div class="col-lg-6 col-12">
                    <div class="row">
                        <div class="col-12 form-label mb-1 fw-medium d-flex flex-row align-items-center">
                            <span>Referral Range</span>
                        </div>
                        <div class="col-12">
                            <div class="d-flex flex-column">
                                <div>
                                    <!-- [inputDisable]="selectedParam?.normal_ranges && selectedParam?.normal_ranges.length != 0" -->
                                    <app-textarea-input [removeCloseIcon]="true" [removeLabel]="true" [rows]="5" classVal="fw-medium form-control rounded-3" labelText="Referral Ranges"
                                    placeHolder="" (onValueChanged)="updateFixedParameter($event, selectedParam, 'referral_range')" 
                                    labelClass="form-label mb-1"[spellcheck]="false" [inputValue]="selectedParam?.referral_range ? selectedParam?.referral_range : ''"
                                    ></app-textarea-input>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- normal ranges  -->
                <div class="col-lg-6 col-12">
                    <div class="row">
                        <div class="col-12 form-label mb-1 fw-medium d-flex flex-row align-items-center">
                            <span>Normal Ranges</span>
                            <button type="button"
                            class="btn btn-primary btn-sm py-0 px-2 rounded-3 ms-2"
                            (click)="openModal(referralRanges, {size: 'lg'}); setNR(selectedParam)">
                            {{selectedParam?.normal_ranges && selectedParam?.normal_ranges.length != 0 ? 'Edit Ranges' : 'Add Ranges'}}
                        </button>
                        </div>
                        <div class="col-12">
                            <div class="d-flex flex-column">
                                <div>
                                    <app-textarea-input [removeCloseIcon]="true" [removeLabel]="true" [rows]="5" classVal="fw-medium form-control rounded-3"
                                    [inputDisable]="true" placeHolder="Click to Enter Ranges" (click)="openModal(referralRanges, {size: 'lg'}); setNR(selectedParam)"
                                    labelClass="form-label mb-1" [spellcheck]="false" [inputValue]="selectedParam?.normal_ranges_display ? selectedParam?.normal_ranges_display : ''"
                                    ></app-textarea-input>
                                </div>
                                <!-- <div>
                                    <button type="button"
                                        class="btn btn-primary btn-sm rounded-3"
                                        (click)="openModal(referralRanges, {size: 'lg'}); setNR(selectedParam)">
                                        {{selectedParam?.normal_ranges && selectedParam?.normal_ranges.length != 0 ? 'Edit Ranges' : 'Add Ranges'}}
                                    </button>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="row">
                <div class="col-12 d-flex justify-content-between">
                    <button class="btn btn-danger gap-2 rounded-3 d-flex justify-content-end flex-nowrap align-items-center "
                        (click)="deleteParams(deleteModal, selectedParam ); modal.dismiss('Cross click');" ngbTooltip="Delete Parameter">
                        <i class="ri-delete-bin-line fs-5"></i> Delete
                    </button>

                    <button class="btn btn-success rounded-3" (click)="resetNormalRanges(); modal.dismiss('Cross click');">Save & Close</button>

                </div>
            </div>

        </div>
    </div>
</ng-template>