<!-- DR AUTHORIZATION COMPONENT  -->
<app-layout [showMap]="false" [showPageTitle]="false" [displayInformation]="false" [labPackage]="false">
    <ng-container class="tabsNavigation">
        <div class="btn-group d-flex flex-wrap rounded-pill font-inter">
            <button type="button" class="btn rounded-pill ms-1 border-0 inactive"
                [ngClass]="{ 'active bg-white text-dark shadow-sm': activeButton === 'all' }"
                (click)="setActiveButton('all')">
                All
            </button>
            <button type="button" class="btn rounded-pill ms-1 border-0 inactive"
                [ngClass]="{ 'active bg-white text-dark shadow-sm': activeButton === 'pending' }"
                (click)="setActiveButton('pending')">
                Pending
            </button>
            <button type="button" class="btn rounded-pill ms-1 border-0 inactive"
                [ngClass]="{ 'active bg-white text-dark shadow-sm': activeButton === 'emergency' }"
                (click)="setActiveButton('emergency')">
                Emergency <span class="bg-danger rounded-pill btn-sm border-0 text-white" *ngIf="emergencyCount && emergencyCount !==0">{{emergencyCount}}</span>
            </button>
            <button type="button" class="btn rounded-pill ms-1 border-0 inactive"
            [ngClass]="{ 'active bg-white text-dark shadow-sm': activeButton == 'reported' }"
            (click)="setActiveButton('reported')">
            Authorized
        </button>
            <button type="button" class="btn rounded-pill ms-1 border-0 inactive text-nowrap"
            [ngClass]="{ 'active bg-white text-dark shadow-sm text-nowrap': activeButton === 'cancelled' }"
            (click)="setActiveButton('cancelled')">
            Cancelled
        </button>
        </div>
    </ng-container>

    <ng-container class="addNewoptions">
        <app-info-btn></app-info-btn>
    </ng-container>

    <ng-container class="searchbox">
        <app-searchbox placeholder="Search" [spellcheck]="false" [applyAutoFocus]="false"
            (searchTermChange)="searchQuery($event)"></app-searchbox>
    </ng-container>

    <ng-container class="datepicker">
            <app-datepicker-section (dateRangeSelected)="getRangeValue($event)" [selectToday]="true"></app-datepicker-section>
    </ng-container>

    <ng-container class="showing">
        <span class="fw-light">Showing</span>
    </ng-container>

    <ng-container class="entries">
        <select class="form-select form-select-sm rounded-3 fw-medium fs-6 w-100 font-DMSans" style="width: auto"
            name="pageSize" placeholder="Select" (change)="changePageNumber($event)">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option [value]="all_count">All</option>
        </select>
    </ng-container>

    <ng-container class="entriesLabel">
        <span class="fw-light">Entries</span>
    </ng-container>

    <ng-container class="TableDisplay">
        <app-datatable>
            <ng-container class="tableheader">
                
                <th class="text-nowrap text-black">Sno.</th>
                <th class="sort1 text-nowrap fullWidthColumn " sortable="name">
                    <div class="d-flex gap-5 align-items-center justify-content-start">
                      <div>Patients</div>
                      <div class="d-flex flex-column align-items-center justify-content-start gap-0 p-0" *ngIf="patients && patients.length != 0">
                        <small ngbTooltip="Latest" style="line-height: 6px;" (click)="changeSorting()"><i class="ri-arrow-up-s-line cursor-pointer" [class.text-black]="sort"></i></small>
                        <small ngbTooltip="Oldest" style="line-height: 6px;" (click)="changeSorting()"><i class="ri-arrow-down-s-line  cursor-pointer" [class.text-black]="!sort"></i></small>
                      </div>
                    </div>
                  </th>
                <th class="text-nowrap"><span>Age & Gender</span></th>
                <th class="sort1 text-nowrap" style="min-width: 100px">Patient IDs</th>
                <th><span>Department</span></th>
                <th class="text-nowrap fullWidthColumn"><span>Lab Test</span></th>
                <!-- <th class="text-nowrap" style="max-width: 175px;"><span>Remarks</span></th> -->
                <th><span>Status</span></th>
                <th class="text-nowrap text-center"><span>Action</span></th>
            </ng-container>

            <ng-container class="tablebody">
                <tr *ngFor="let item of patients; let i = index" class="td-color">
                    <td class="fw-semibold text-black">{{i+1}}.</td>
                    <td>
                        <div class="d-flex flex-row gap-1">
                            <span class="text-black text-nowrap fs-6 fw-medium"
                              *ngIf="item.title!== null">{{item.patient.title}}</span>
                            <span class="text-black text-nowrap fs-6 fw-medium">
                              <ngb-highlight [result]="item.patient.name" [term]="query"></ngb-highlight>
                            </span>
                          </div>
                          <small class="text-nowrap">
                            {{timeSrvc.decodeTimestamp(item.added_on)}}
                          </small>
                        <!-- </div> -->
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <small>
                                {{item.patient.age}} {{item.patient.ULabPatientAge}}
                            </small>
                            <small>
                                {{item.patient.gender}}
                            </small>
                        </div>
                    </td>

                    <td>
                        <div class="container-full flex-column IDs" style=" min-width: 130px">
                          <div class="row IDs g-0 d-flex flex-nowrap align-items-end justify-content-between">
                            <div class="col-4 px-0 d-flex flex-row flex-nowrap" style="vertical-align: bottom;">
                              <small style="vertical-align: bottom;">
                                <small class="d-flex flex-row text-nowrap" style="vertical-align: bottom;">
                                  MR NO :
                                </small>
                              </small>
                            </div>
                            <small class="col-8 ps-0 d-flex flex-row">
                              <ngb-highlight [result]="item.patient.mr_no" [term]="query"></ngb-highlight>
                            </small>
                          </div>
                          <div class="row IDs g-0 d-flex flex-nowrap align-items-center">
                            <div class="col-4 px-0">
                              <small>
                                <small class="d-flex flex-row text-nowrap">
                                  VISIT ID :
                                </small>
                              </small>
                            </div>
                            <small class="col-8 ps-0">
                              <ngb-highlight [result]="item.patient.visit_id" [term]="query"></ngb-highlight>
                            </small>
                          </div>
                        </div>
                      </td>


                    <td>
                        <small class="text-black">
                            <ngb-highlight [result]="item.department" [term]="query"></ngb-highlight>
                        </small>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium text-nowrap text-black">
                                <ngb-highlight [result]="item.name" [term]="query"></ngb-highlight>
                            </span>
                        </div>
                    </td>

                    <td class="text-wrap">

                        <span *ngIf="item?.status_id.includes('Emergency') || item?.status_id.includes('Urgent')">
                            <small class="text-danger rounded-3 px-1 py-1">{{item?.status_id}}</small>
                        </span>
                        <span *ngIf="!item?.status_id.includes('Emergency') && !item?.status_id.includes('Urgent')">
                            <small class="rounded-3 px-1 py-1">{{item?.status_id}}</small>
                        </span>
                    </td>
                    <td class="text-nowrap text-center">
                        <div>
                            <button class="btn btn-primary btn-sm rounded-3 text-nowrap" (click)="openXl(content, item)">View Report</button>
                        </div>
                    </td>
                </tr>
            </ng-container>

            <ng-container class="tablebody">
                <tr *ngIf="!patients || patients.length === 0">
                    <td colspan="8">
                        <div class="td-color fs-6 d-flex align-items-center justify-content-center " style="vertical-align: middle;min-height: 100px;">
                            <!-- NO PATIENTS -->
                            <span *ngIf="query!==''">
                              No Data Found with Search Query "<span class="fw-bold text-black">{{query}}</span>"
                            </span>

                            <span *ngIf="query==='' && !pageLoading">
                                No patients registered on this day.
                              </span>
                
                              <span *ngIf="pageLoading" class="d-flex flex-column align-items-center py-5">
                                <div class="spinner-border" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="text-black pt-2 fw-light">Loading</div>
                              </span>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </app-datatable>
    </ng-container>

    <ng-container class="paginationEntries">
        <span class="text-nowrap">Showing {{(page_number * page_size) - page_size + 1}} to {{(page_number * page_size) <
                all_count ? page_number * page_size : all_count}} of {{ all_count ? all_count : 0 }} Entries</span>
    </ng-container>

    <ng-container class="pager">
        <app-pagination [collectionSize]="all_count || 0" [page]="page_number" [pageSize]="page_size"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </ng-container>

</app-layout>


<ng-template #content let-modal>
    <div class="modal-header py-2 d-flex flex-lg-row flex-column px-3 bg-light-blue">
        <span class="modal-title fs-5" id="modal-basic-title">{{title}}</span>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click');"></button>
    </div>
    <div class="modal-body" style="background-color: #F8FAFC;">
        <div class="container-full p-0" style="min-height: 300px !important;">


            <!-- MODAL TABLE  -->
            <div class="row font-DMSans mb-3" *ngFor="let report of reportTableData">

                <div class="col-12 mb-1 text-center">
                    <span class="fs-4 fw-semibold font-Readex">
                        {{report.groupname}}
                    </span>
                </div>

                <app-datatable tableClass="table table-striped" tableHeaderClass="bg-dark text-white" class="mb-3">
                    <ng-container class="tableheader">
                      
                        <th class="border-end border-white">Parameter</th>
                        <th class="text-center border-end border-white"
                            style="min-width: 210px;max-width: 210px;width: 210px">Value</th>
                        <th class="text-center border-end border-white">Unit</th>
                        <!-- <th class="text-center border-end border-white">Method</th> -->
                        <th class="text-center border-end border-white">Reference Range</th>
                    </ng-container>

                    <ng-container class="tablebody">

                        <tr class="bg-white font-Readex" *ngFor="let item of report.parameters">
                      
                            <td class="fs-5 fw-medium border-end">
                                <div class="d-flex flex-column ">
                                    <span class="fs-5 fw-medium">
                                        {{item.parameter}}
                                    </span>
                                    <small class="font-italic td-color">
                                        <i>{{item?.method ? item?.method : ''}}</i>
                                    </small>
                                </div>
                            </td>

                            <td colspan="1" class="py-2 border-end text-center">
                                <span [class.fw-bold]="item.is_value_bold">{{item.value}}</span>
                            </td>
                            <td class="fs-6 text-center border-end">{{item.units}}</td>
                            <td class="text-center border-end">
                                <div [innerHTML]="withoutSpecChars(item.referral_range)"></div>
                            </td>
                        </tr>
                    </ng-container>

                    <ng-container class="tablebody">
                        <tr *ngIf="!reportTableData || reportTableData.length === 0">
                            <td colspan="4">
                                <div class="td-color fs-6 py-5 font-monsterract fw-medium d-flex flex-column align-items-center justify-content-center"
                                    style="vertical-align: middle;min-height: 100px;">
                                    <!-- NO PATIENTS -->
                                    <!-- <img src="/assets/images/file.png" style="width:17%"> -->
                                    <!-- <span>NO DATA</span> -->
                                </div>
                            </td>
                        </tr>
                    </ng-container>

                </app-datatable>
            </div>

            <div class="row bottom-0" *ngIf="this.patient_remark && this.patient_remark !== '<p></p>'">
                <div class="col-12">
                    Remark : {{this.patient_remark ? this.patient_remark : "--"}}
                </div>
            </div>

        </div>
    </div>

    <!-- <div class="bg-light-blue px-2 py-2">
                  <div class="row g-2 justify-content-between">
                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
                        <div class="row g-0 justify-content-start">
                            <div class="col-3 d-flex justify-content-center text-center">
                                <span class="input-group-text text-center w-100 rounded-start rounded-0" id="inputGroup-sizing">Remarks</span>
                            </div>
                            <div class="col-6">
                                <app-input [removeLabel]="true" classVal="form-control fw-light rounded-0" placeHolder="Enter Remarks"></app-input>
                            </div>
                            <div class="col-3">
                                <app-submitbutton buttonText="Re-Test" classVal="w-100 btn btn-warning rounded-end rounded-0"></app-submitbutton>
                            </div>
                        </div>
                    </div>
        
                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 ">
                        <div class="row g-0 justify-content-end">
                            <div class="col-3">
                                <span class="input-group-text text-center rounded-start rounded-0" id="inputGroup-sizing"><i class="bi bi-key-fill pe-1"></i>Passkey</span>
                            </div>
                            <div class="col-6">
                                <app-input inputType="password" [removeLabel]="true" classVal="form-control rounded-0" placeHolder="Enter Passkey"></app-input>
                            </div>
                            <div class="col-3">
                                <app-submitbutton buttonText="Authorize" classVal="w-100 btn btn-success rounded-end rounded-0"></app-submitbutton>
                            </div>
                        </div>
                    </div>
                    
                  </div>
     </div> -->


    <div class="bg-light-blue modal-footer px-2 py-1 rounded-bottom overflow-hidden border-top" *ngIf="activeButton!= 'reported' && activeButton!= 'cancelled'">
        <div class="row">
            <div class="col-12 d-flex justify-content-end align-items-end">
                <button class="btn btn-success rounded-3" [disabled]="saveLoading"
                (click)="sendAuthorization();">
                    <span *ngIf="!saveLoading">Authorize</span>
                    <span *ngIf="saveLoading" class="spinner-border spinner-border-sm mr-1 "></span>
                </button>
            </div>
        </div>
    </div>
</ng-template>


<ng-template #wordReport let-modal>
    <div class="modal-header py-2 px-3 bg-light-blue justify-content-between align-items-center">
        <span class="modal-title fs-5" id="modal-basic-title">{{ title }}</span>
        <div class="d-flex align-items-center">
            <button *ngIf="activeButton!= 'reported'"
            (click)="sendAuthorization();" 
            class="btn btn-success me-2 rounded-3">
            <span *ngIf="!saveLoading">Authorize</span>
            <span *ngIf="saveLoading" class="spinner-border spinner-border-sm mr-1 "></span>
        </button>

            <button type="button" class="btn-close" aria-label="Close"
                (click)="submitted=false;modal.dismiss('Cross click');"></button>
        </div>
    </div>
    

    <div class="modal-body p-0">
        <div class="container-full p-0" style="height: 87vh;">
            <div class="row p-0 g-0 overflow-hidden" >

                <!-- <app-test-editor [disableEditor]="true" [content]="htmlData" 
                 [pages_content]="all_pages"
                [header_to_diplay_in_every_page]="htmlHeader"></app-test-editor> -->

                <!-- <app-editor-iframe [disableEditor]="true" [content]="htmlData" 
               [pages_content]="all_pages"
                 [header_to_diplay_in_every_page]="htmlHeader"
                ></app-editor-iframe> -->

                <app-dev-rich #devRichEdit 
                [isDisabled]="true"
                [blankDocumentWithHeader]="htmlHeader"
                [content]="htmlData" 
                [showHeader]="true"
                [content]="htmlData" 
                [header_to_diplay_in_every_page]="htmlHeader"
                [patient]="patient">
            </app-dev-rich>
             
            </div>
        </div>
    </div>
</ng-template>

<ng-template #remark let-modal>
    <div class="modal-header py-2 px-3 bg-white justify-content-between align-items-center border-bottom">
        <span class="modal-title fs-6" id="modal-basic-title">{{ title }}</span>
        <div class="d-flex align-items-center">
            <button type="button" class="btn-close btn-sm" aria-label="Close"
                (click)="submitted=false;modal.dismiss('Cross click');"></button>
        </div>
    </div>

    <div class="modal-body">
        <div class="container-full" >
            <div class="row">
                    <div class="col-12">
                        {{patient_remark}}
                    </div>
                </div>
            </div>
        </div>
</ng-template>    